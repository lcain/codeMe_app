var currentUserID = 0;

$(document).ready(function(){ 
  var currentUserExists = $('#HIDE').text();
  // console.log(currentUserExists === '\n  ');
  // console.log(currentUserExists.split(""))
  if ( currentUserExists !== "" ){ 
    currentUserID = JSON.parse(currentUserExists) 
  };
  
  $('.button').on('click', function(e){
    if (e.currentTarget.id === "signout"){
      $.ajax({
        url: '/users/sign_out',
        method: 'DELETE'
      }).done(function(){
        document.location.href="/"
      })

    } else if (e.currentTarget.id === "signin"){
      var email = $('#email').val();
      var password = $('#password').val();

      var req = {
        headers: {
          'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
        },
        url: "/users/sign_in",
        method: "POST",
        dataType: 'json',
        data: {  
          user: {
            "email": email,
            "password": password,
            "remember_me": 1
          }
        }
      }  
    
      $.ajax(req).done(function(data){
        window.current_user = data;
        currentUserID = data.id;

        $(".save").removeClass("hidden");

        var ret = '';
        $('.login').html(
          '<li class="nav button" id="signout">Log out '+ data.email +'</li>'
        );

        $.ajax({
          url: 'finderID',
          method: 'PUT',
          dataType: 'json',
          data: {
            individual: data.id
          }
        }).done(function(data){
          $('#txt').val(data.content);
          console.log(data.id);
          $('#userPage').html($('#txt').val());
          history.pushState( {}, '', '/hypertexts/' + data.id );

        });

        $('.button').on('click', function(e){
          // console.log('clicked')
          if (e.currentTarget.id === "signout"){
            $.ajax({
              url: '/users/sign_out',
              method: 'DELETE'
            }).done(function(){
              document.location.href="/"
            })
          }
        });
      })

    } else if (e.currentTarget.id === "signup"){
      // console.log('YOU CLICKED ME')
      var email = $('#email').val();
      var password = $('#password').val();
      var hypertext = $('#txt').val();
      var req = {
        headers: {
          'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
        },
        url: "/users",
        method: "POST",
        dataType: 'json',
        data: {  
          user: {
            "email": email,
            "password": password,
            "password_confirmation": password,
            "remember_me": 1,
            "hypertext": hypertext
          }
        }
      }
      $.ajax(req).done(function(data){
        currentUserID = data.id;
        var ret = '';
        $('.login').html(
          '<li class="nav button" id="signout">Log out '+ data.email +'</li>'
        );

        $('.button').on('click', function(e){
          // console.log('clicked')
          if (e.currentTarget.id === "signout"){
            $.ajax({
              url: '/users/sign_out',
              method: 'DELETE'
            }).done(function(){
              document.location.href="/"
            })
          }
        });
      })

    } else if (e.currentTarget.id === "savesies") {
      var updatedText = sanitizeText( $('#txt').val() );

      $.ajax({
        url: '/finderID',
        method: 'PUT',
        dataType: 'json',
        data: {
          individual: currentUserID
        }
      }).done(function(data){
        console.log(data)
        $.ajax({
          url: '/hypertexts/' + data.id,
          method: 'PUT',
          dataType: 'json',
          data: {
            hypertext: {
              content: updatedText,
              id: data.id
            }
          }
        }).done(function() {
          console.log('success!!!!!!!!!!');
        });
      });
    }
  
  });

  // $(document).change(function(){
  //   console.log("document changed")
  //   $('.button').on('click', function(e){
  //     console.log('clicked')
  //     if (e.currentTarget.id === "signout"){
  //       $.ajax({
  //         url: '/users/sign_out',
  //         method: 'DELETE'
  //       }).done(function(){
  //         document.location.href="/"
  //       })
  //     }
  //   });
  // });


});

